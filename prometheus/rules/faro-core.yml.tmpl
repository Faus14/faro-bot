groups:

# ===== Validator =====
- name: validator.rules
  rules:
  - alert: ValidatorNoAttestations
    expr: increase(lighthouse_validator_attestations_published_total[5m]) == 0
    for: 3m
    labels:
      severity: critical
      component: validator
    annotations:
      summary: "Validator no está publicando attestations"
      description: "No se detectaron attestations publicadas en los últimos 5 minutos."

  - alert: ValidatorDown
    expr: up{job="lighthouse_vc"} == 0
    for: 1m
    labels:
      severity: critical
      component: validator
    annotations:
      summary: "Validator Client DOWN"
      description: "El Validator Client no responde (job=lighthouse_vc)."

# ===== Beacon Node =====
- name: beacon.rules
  rules:
  - alert: BeaconNodeDown
    expr: up{job="lighthouse_bn"} == 0
    for: 1m
    labels:
      severity: critical
      component: beacon
    annotations:
      summary: "Beacon Node DOWN"
      description: "El Beacon Node no responde (job=lighthouse_bn)."

  - alert: BeaconPeersLow
    expr: lighthouse_network_peers_total < {{ env "BN_PEERS_THRESHOLD" | default "30" }}
    for: 5m
    labels:
      severity: warning
      component: beacon
    annotations:
      summary: "Peers bajos en Beacon Node"
      description: "Peers actuales: {{ $value }} (<{{ env \"BN_PEERS_THRESHOLD\" | default \"30\" }}). Puede afectar inclusion/eficiencia."

# ===== Execution (Geth) =====
- name: execution.rules
  rules:
  - alert: ExecutionNodeDown
    expr: up{job="geth"} == 0
    for: 1m
    labels:
      severity: critical
      component: execution
    annotations:
      summary: "Execution (Geth) DOWN"
      description: "El Execution Layer no responde (job=geth)."

  - alert: ExecutionPeersLow
    expr: geth_peers < {{ env "GETH_PEERS_THRESHOLD" | default "25" }}
    for: 5m
    labels:
      severity: warning
      component: execution
    annotations:
      summary: "Peers bajos en Geth"
      description: "Peers actuales: {{ $value }} (<{{ env \"GETH_PEERS_THRESHOLD\" | default \"25\" }})."

# ===== Host (VPS) =====
- name: host.rules
  rules:
  - alert: HostMemoryHigh
    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > {{ env "HOST_MEM_THRESHOLD" | default "90" }}
    for: 5m
    labels:
      severity: warning
      component: host
    annotations:
      summary: "Uso de RAM alto"
      description: "La RAM supera el {{ env \"HOST_MEM_THRESHOLD\" | default \"90\" }}% de uso (actual: {{ $value | printf \"%.1f\" }}%)."

  - alert: HostDiskUsageHigh
    expr: |
      (1 - (
        node_filesystem_avail_bytes{mountpoint="/",fstype!~"tmpfs|overlay"} /
        node_filesystem_size_bytes{mountpoint="/",fstype!~"tmpfs|overlay"}
      )) * 100 > {{ env "HOST_DISK_THRESHOLD" | default "90" }}
    for: 10m
    labels:
      severity: warning
      component: host
    annotations:
      summary: "Uso de disco (/) alto"
      description: "Uso de disco en / supera {{ env \"HOST_DISK_THRESHOLD\" | default \"90\" }}% (actual: {{ $value | printf \"%.1f\" }}%)."

  - alert: HostCPUHigh
    expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > {{ env "HOST_CPU_THRESHOLD" | default "90" }}
    for: 10m
    labels:
      severity: warning
      component: host
    annotations:
      summary: "CPU alta sostenida"
      description: "Uso de CPU >{{ env \"HOST_CPU_THRESHOLD\" | default \"90\" }}% por 10 minutos (actual: {{ $value | printf \"%.1f\" }}%)."
